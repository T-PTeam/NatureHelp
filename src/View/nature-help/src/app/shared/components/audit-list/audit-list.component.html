<ng-container *ngIf="auditService.deficiencyHistory$ | async as logs">
  <mat-accordion>
    <mat-expansion-panel
      data-cy="history-expansion-panel"
      (opened)="loadChangedModelHistory(deficiency.id, deficiency.type)">
      <mat-expansion-panel-header>
        <mat-panel-title i18n="@@historyOfChanges"> History of changes </mat-panel-title>
        <mat-panel-description>
          {{ logs && logs.length ? logs.length + " entries" : "" }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div *ngIf="logs.length; else noLogs">
        <div
          *ngFor="let log of logs"
          class="log-entry">
          <div class="log-header mb-2">
            <strong>ID {{ log.deficiencyId }}</strong>
            <p
              i18n="@@changedBy"
              class="user">
              Changed by {{ log.createdBy }}
            </p>
            <span
              i18n="@@changedOn"
              class="time"
              >Changed on {{ log.createdOn | date: "short" }}</span
            >
          </div>

          <table
            mat-table
            [dataSource]="getParsedChangesArray(log.changesJson)"
            class="mat-elevation-z2"
            multiTemplateDataRows>
            <ng-container matColumnDef="property">
              <th
                i18n="@@property"
                mat-header-cell
                *matHeaderCellDef>
                Property
              </th>
              <td
                mat-cell
                *matCellDef="let element">
                {{ element.key }}
              </td>
            </ng-container>

            <ng-container matColumnDef="old">
              <th
                i18n="@@oldValue"
                mat-header-cell
                *matHeaderCellDef>
                Old
              </th>
              <td
                mat-cell
                *matCellDef="let element">
                {{ element.old }}
              </td>
            </ng-container>

            <ng-container matColumnDef="new">
              <th
                i18n="@@newValue"
                mat-header-cell
                *matHeaderCellDef>
                New
              </th>
              <td
                mat-cell
                *matCellDef="let element">
                {{ element.new }}
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"></tr>
          </table>

          <mat-divider class="my-4"></mat-divider>
        </div>
      </div>

      <ng-template #noLogs>
        <p
          i18n="@@noChangeHistory"
          class="text-muted p-3">
          No change history available.
        </p>
      </ng-template>
    </mat-expansion-panel>
  </mat-accordion>
</ng-container>
